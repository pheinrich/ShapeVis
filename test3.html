<html>
  <head>
    <title>Test Outline Display</title>

    <style type="text/css">
      SECTION#shape-vis CANVAS.preview {
        border: 1px solid black; }
    </style>

    <script type="text/javascript" src="/sites/all/modules/jquery_update/replace/jquery.min.js?x"></script>
    <script type="text/javascript" src="outline.js"></script>
  </head>
  <body>
    <h2>Test Outline Display</h2>

    <section id="shape-vis">
      <canvas class="preview" width="500" height="500">
        Canvas element not supported.
      </canvas>
      <input type="range" min="-3" max="3" value="0" onchange="setZoom( this.value )"/>
      <span id="zoom">0</span>
    </section>

    <script type="text/javascript">
      var ro = new EllipseOutline( 150, 275 );
      var handle = null;

      var root = $("#shape-vis");
      var canvas = root.find( "canvas" )[0];
      var context = canvas.getContext( "2d" );

      var extent = ro.getExtent();
      var zoom = 1;
      var tx = canvas.width / 2, ty = canvas.height / 2;

      function setZoom( level )
      {
        $("#zoom").html( level );
        zoom = Math.pow( 2, level );
        redraw();
      }

      function getPosition( event )
      {
        var target;

        if( !event )
	  event = window.event;

        if( event.target )
	  target = event.target;
        else if( event.srcElement )
	  target = event.srcElement;

        // Defeat Safari bug.
        if( 3 == target.nodeType )
	  target = target.parentNode;

        var x = event.pageX - $(target).offset().left;
        var y = event.pageY - $(target).offset().top;

        return {
	  x: (x - tx) / zoom,
	  y: (y - ty) / zoom
        };
      }

      function draw()
      {
          context.save();
          context.transform( zoom, 0, 0, zoom, tx, ty );
          ro.trace( context );
          context.restore();

          context.fillStyle = "#eda";
          context.strokeStyle = "#000";
          context.lineWidth = 3;

          context.fill();
          context.stroke();
      }

      function mouseMove()
      {
        if( ro.resize( handle, getPosition() ) )
          redraw();
      }

      function redraw()
      {
        context.clearRect( 0, 0, canvas.width, canvas.height );
        draw();
      }

      function mouseDown()
      {
        handle = ro.getHandle( getPosition(), zoom );
      }

      function mouseUp()
      {
        handle = null;
      }

      canvas.addEventListener( "mousemove", mouseMove, false );
      canvas.addEventListener( "mousedown", mouseDown, false );
      canvas.addEventListener( "mouseup",   mouseUp,   false );

      draw();
    </script>
  </body>
</html>
