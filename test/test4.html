<html>
  <head>
    <title>Test Outline Display</title>

    <link rel="stylesheet" type="text/css" href="/js/css/flick/jquery-ui-1.8.18.custom.css"/>
    <style type="text/css">
      SECTION.preview {
        min-height: 550px; }
      SECTION.preview DIV.view {
        float: left;
        margin-right: 10px; }
      SECTION.preview CANVAS {
        border: 1px solid black;
        display: block; }
      SECTION.preview DIV.zoom {
        float: right;
        text-align: right;
        vertical-align: top; }
      SECTION.preview DIV.zoom SPAN {
        vertical-align: top; }
      SECTION.preview DIV.controls {
        overflow: hidden; }
      SECTION.preview HR {
        margin-bottom: 25px; }
      SECTION.preview DIV.controls SPAN.cost {
        display: block;
        font-size: 1.5em; }
      SECTION.preview DIV.controls SPAN.area {
        display: block;
        font-size: 0.75em; }
      SECTION.preview DIV.dimensions SPAN {
        display: block;
        margin-top: 1em; }
    </style>

    <style>
      #tabs { margin-top: 1em; }
      #tabs li .ui-icon-close { float: left; margin: 0.4em 0.2em 0 0; cursor: pointer; }
      #add_tab { cursor: pointer; }
    </style>

    <script type="text/javascript" src="/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="/js/jquery-ui-1.8.18.custom.min.js"></script>
    <script type="text/javascript" src="mirror.js"></script>
    <script type="text/javascript" src="outline.js"></script>
  </head>
  <body>
    <div>
      <button id="add_tab">New...</button>
      <div>
        <script type="text/javascript">
          ShapeVis.tabContent();
        </script>
      </div>
      <div id="tabs">
        <ul>
          <li><a href="#tabs-1">Rectangle</a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>
        </ul>
        <div id="tabs-1">
          <section class="preview">
            <div class="view">
              <canvas width="500" height="500">
                Canvas element not supported.
              </canvas>

              <div class="zoom">
                Zoom: <input type="range" min="0" max="5" value="5" onchange="setZoom( this.value )"/> <span>5</span>
              </div>
              <input type="checkbox" value="lock" onchange="setAspectLock( this )"/> Lock Aspect Ratio
            </div>

            <div class="controls">
              <input type="text" class="title" size="20"/>
              <select>
                <option value="circle">Circle</options>
                <option value="ellipse">Oval</option>
                <option value="rectangle">Rectangle</option>
                <option value="square">Square</options>
                <option value="diamond">Diamond</options>
                <option value="cathedral">Cathedral</options>
                <option value="gothic">Gothic</options>
                <option value="vesica">Vesica</options>
              </select>

              <hr/>

              <span class="cost">Cost: <span>0</span></span>
              <span class="area">Area: <span>0</span></span>

              <div class="dimensions">
                <span>Outside:</span>
                <input type="text" class="width" size="8"/> &times; <input type="text" class="height" size="8"/>

                <span>Inside:</span>
                <input type="text" class="iwidth" size="8"/> &times; <input type="text" class="iheight" size="8"/>

                <span>Border:</span>
                <input type="text" class="border" size="8"/> <input type="button" value="Make Uniform" onclick="resetBorder()"/>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <script>
      $(function() {
        var tab_counter = 2;

        // tabs init with a custom tab template and an "add" callback filling in the content
        var $tabs = $("#tabs").tabs({
          tabTemplate: "<li><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close'>Remove Tab</span></li>",
          add: function( event, ui ) {
//            var tab_content = "Tab " + tab_counter + " content.";
//            $(ui.panel).append( "<p>" + tab_content + "</p>" );
            $(ui.panel).load( "tabcontent.html" );
          }
        });

        $("#add_tab").button().click( function() {
          var tab_title = "Tab " + tab_counter;

          $tabs.tabs( "add", "#tabs-" + tab_counter, tab_title ).find( ".ui-tabs-nav" ).sortable( {axis: "x"} );
          tab_counter++;
        });

        // close icon: removing the tab on click
        $("#tabs span.ui-icon-close").live( "click", function() {
          var index = $("li", $tabs).index( $(this).parent() );
          $tabs.tabs( "remove", index );
        });

        var oo = new EllipseOutline( 1500, 2750 );
        var io = new EllipseOutline( 1000, 2250 );
        var handle = null, selected = null;;

        var root = $("#tabs-1");
        var canvas = root.find( "canvas" )[0];
        var context = canvas.getContext( "2d" );

        var zoom = 1;
        var tx = canvas.width / 2, ty = canvas.height / 2;
        var lockAspect = false, lockBorder = true;;

        function setZoom( level )
        {
          $("#zoom").html( level );
          zoom = Math.pow( 1.5, level - 10 );
          redraw();
        }

        function setAspectLock( checkbox )
        {
          lockAspect = $(checkbox).is( ":checked" );
        }

        function resetBorder()
        {
          var inside = io.getExtent();
          var outside = oo.getExtent();
          var border = Math.min( outside.width - inside.width, outside.height - inside.height );

          inside.width = outside.width - border;
          inside.height = outside.height - border;
          inside.left = -inside.width / 2;
          inside.top = -inside.height / 2;

          io.setExtent( inside );
          redraw();
        }

        function getPosition( event )
        {
          var target;

          if( !event )
	    event = window.event;

          if( event.target )
	    target = event.target;
          else if( event.srcElement )
	    target = event.srcElement;

          // Defeat Safari bug.
          if( 3 == target.nodeType )
	    target = target.parentNode;

          var x = event.pageX - $(target).offset().left;
          var y = event.pageY - $(target).offset().top;

          return {
	    x: (x - tx) / zoom,
	    y: (y - ty) / zoom
          };
        }

        function draw()
        {
            var area = oo.getArea();

            var extent = oo.getExtent();
            $("#width").val( (Math.round( extent.width ) / 100) + " in" );
            $("#height").val( (Math.round( extent.height ) / 100) + " in" );

            context.save();
            context.transform( zoom, 0, 0, zoom, tx, ty );
            oo.trace( context );
            context.restore();

            context.fillStyle = "#eda";
            context.strokeStyle = "#000";
            context.lineWidth = 3;
            context.fill();
            context.stroke();

            context.save();
            context.transform( zoom, 0, 0, zoom, tx, ty );
            io.trace( context );
            context.restore();

            area -= io.getArea();
            $("#area").html( (Math.round( area / 14400 ) / 100) + " ft<sup>2</sup> (" +
                             (Math.round( area / 100 ) / 100) + " in<sup>2</sup>)" );
            $("#cost").html( "$" + (Math.round( 325 * area / 14400 ) / 100) );

            extent = io.getExtent();
            $("#iwidth").val( (Math.round( extent.width ) / 100) + " in" );
            $("#iheight").val( (Math.round( extent.height ) / 100) + " in" );

            var gradient = context.createLinearGradient( 0, 0, canvas.width, canvas.height );
            gradient.addColorStop( 0, "#aaa" );
            gradient.addColorStop( 1, "#fff" );

            context.fillStyle = gradient;
            context.lineWidth = 2;
            context.fill();
            context.stroke();
        }

        function mouseMove()
        {
          if( handle )
          {
            var point = getPosition();
            var dirty = false;

            handle.delta = { x: point.x - handle.x, y: point.y - handle.y };

            if( selected == oo )
              dirty = oo.resize( handle, null, lockAspect );

            if( dirty || selected == io )
              dirty |= io.resize( handle, null, lockAspect );

            if( dirty )
            {
              handle.x = point.x; handle.y = point.y;
              redraw();
            }
          }
        }

        function redraw()
        {
          context.clearRect( 0, 0, canvas.width, canvas.height );
          draw();
        }

        function mouseDown()
        {
          handle = oo.getHandle( getPosition(), Outline.handleSize / zoom );
          if( handle )
            selected = oo;
          else
          {
            handle = io.getHandle( getPosition(), Outline.handleSize / zoom );
            if( handle )
              selected = io;
          }
        }

        function mouseUp()
        {
          handle = null;
          selected = null;
        }

        canvas.addEventListener( "mousemove", mouseMove, false );
        canvas.addEventListener( "mousedown", mouseDown, false );
        canvas.addEventListener( "mouseup",   mouseUp,   false );

        setZoom( 5 );
      });
    </script>
  </body>
</html>
